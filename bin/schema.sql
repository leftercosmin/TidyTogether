START TRANSACTION;

CREATE DATABASE IF NOT EXISTS TidyTogether;
USE TidyTogether;

DROP TABLE IF EXISTS RecyclingArea;
DROP TABLE IF EXISTS Mark;
DROP TABLE IF EXISTS Media;
DROP TABLE IF EXISTS LovedZone;
DROP TABLE IF EXISTS Post;
DROP TABLE IF EXISTS User;
DROP TABLE IF EXISTS Secret;
DROP TABLE IF EXISTS Zone;
DROP TABLE IF EXISTS Tag;
DROP TABLE IF EXISTS Coordinate;

CREATE TABLE User (
  id        BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  email     VARCHAR(255) UNIQUE NOT NULL,
  password  VARCHAR(255) NOT NULL,
  mainCity  VARCHAR(255),
  fname     VARCHAR(255),
  lname     VARCHAR(255),
  role      ENUM('civilian', 'supervisor', 'authority') NOT NULL,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE Secret (
  hashed VARCHAR(255) PRIMARY KEY,
  email VARCHAR(255), -- NOT UNIQUE, HAS TO BE NULLABLE
  
  INDEX (email)
);

CREATE TABLE Zone (
  id      BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  name    VARCHAR(255) NOT NULL,
  city    VARCHAR(255) NOT NULL,
  country VARCHAR(255)
);

CREATE TABLE LovedZone (
  idUser BIGINT UNSIGNED,
  idZone BIGINT UNSIGNED,
  lat DOUBLE,
  lng DOUBLE,
  
  PRIMARY KEY (idUser, idZone),
  INDEX (idUser),
  INDEX (idZone),
  FOREIGN KEY (idUser) REFERENCES User(id) ON DELETE CASCADE ON UPDATE CASCADE,
  FOREIGN KEY (idZone) REFERENCES Zone(id) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE Post (
  id          BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  description VARCHAR(255),
  status      ENUM('pending', 'inProgress', 'done') NOT NULL DEFAULT 'pending',
  idUser      BIGINT UNSIGNED NOT NULL,
  idZone      BIGINT UNSIGNED NOT NULL,
  address     VARCHAR(255) NOT NULL,
  createdAt   DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt   DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX (idUser),
  INDEX (idZone),
  FOREIGN KEY (idUser) REFERENCES User(id) ON DELETE CASCADE ON UPDATE CASCADE,
  FOREIGN KEY (idZone) REFERENCES Zone(id) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE Media (
  id     BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  name   VARCHAR(255) NOT NULL,
  size   BIGINT UNSIGNED NOT NULL,
  source VARCHAR(255) NOT NULL,
  format ENUM('jpg', 'png', 'mp4', 'webm') NOT NULL,
  idPost BIGINT UNSIGNED NOT NULL,
  
  INDEX (idPost),
  FOREIGN KEY (idPost) REFERENCES Post(id) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE Tag (
  id    BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  name  VARCHAR(255) UNIQUE NOT NULL,
  color ENUM('red', 'orange', 'yellow', 'blue', 'purple', 'green') NOT NULL
);

CREATE TABLE Mark (
  idTag  BIGINT UNSIGNED,
  idPost BIGINT UNSIGNED,
  
  PRIMARY KEY (idTag, idPost),
  INDEX (idTag),
  INDEX (idPost),
  FOREIGN KEY (idTag) REFERENCES Tag(id) ON DELETE CASCADE ON UPDATE CASCADE,
  FOREIGN KEY (idPost) REFERENCES Post(id) ON DELETE CASCADE ON UPDATE CASCADE
);

-- authority tables
CREATE TABLE Coordinate (
  id        BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  address   VARCHAR(255),
  lat       DOUBLE NOT NULL,
  lng       DOUBLE NOT NULL,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,

  INDEX (lat),
  UNIQUE(lat, lng)
);

CREATE TABLE RecyclingArea (
  idTag        BIGINT UNSIGNED,
  idUser       BIGINT UNSIGNED,
  idCoordinate BIGINT UNSIGNED,
  createdAt    DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt    DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (idTag, idCoordinate),
  INDEX (idTag),
  INDEX (idCoordinate),
  FOREIGN KEY (idTag) REFERENCES Tag(id) ON DELETE CASCADE ON UPDATE CASCADE,
  FOREIGN KEY (idUser) REFERENCES User(id) ON DELETE CASCADE ON UPDATE CASCADE,
  FOREIGN KEY (idCoordinate) REFERENCES Coordinate(id) ON DELETE CASCADE ON UPDATE CASCADE
);

COMMIT;
