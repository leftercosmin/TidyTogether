START TRANSACTION;

CREATE DATABASE IF NOT EXISTS TidyTogether;
USE TidyTogether;

DROP TABLE IF EXISTS Mark;
DROP TABLE IF EXISTS Media;
DROP TABLE IF EXISTS LovedZone;
DROP TABLE IF EXISTS Post;
DROP TABLE IF EXISTS User;
DROP TABLE IF EXISTS Zone;
DROP TABLE IF EXISTS Tag;

CREATE TABLE User (
  id        BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  email     VARCHAR(255) UNIQUE NOT NULL,
  password  VARCHAR(255) NOT NULL,
  fname     VARCHAR(255),
  lname     VARCHAR(255),
  role      ENUM('civilian', 'supervisor', 'authority') NOT NULL,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE Zone (
  id      BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  name    VARCHAR(255) NOT NULL,
  city    VARCHAR(255) NOT NULL,
  country VARCHAR(255)
);

CREATE TABLE LovedZone (
  idUser BIGINT UNSIGNED,
  idZone BIGINT UNSIGNED,
  
  PRIMARY KEY (idUser, idZone),
  INDEX (idUser),
  INDEX (idZone),
  FOREIGN KEY (idUser) REFERENCES User(id) ON DELETE CASCADE,
  FOREIGN KEY (idZone) REFERENCES Zone(id) ON DELETE CASCADE
);

CREATE TABLE Post (
  id          BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  description VARCHAR(255),
  status      ENUM('pending', 'inProgress', 'done') NOT NULL DEFAULT 'pending',
  idUser      BIGINT UNSIGNED NOT NULL,
  idZone      BIGINT UNSIGNED NOT NULL,
  address     VARCHAR(255) NOT NULL,
  createdAt   DATETIME DEFAULT CURRENT_TIMESTAMP,
  updatedAt   DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  INDEX (idUser),
  INDEX (idZone),
  FOREIGN KEY (idUser) REFERENCES User(id) ON DELETE CASCADE,
  FOREIGN KEY (idZone) REFERENCES Zone(id) ON DELETE CASCADE
);

CREATE TABLE Media (
  id     BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  name   VARCHAR(255) NOT NULL,
  size   BIGINT UNSIGNED NOT NULL,
  source VARCHAR(255) NOT NULL,
  format ENUM('jpg', 'png', 'mp4', 'webm') NOT NULL,
  idPost BIGINT UNSIGNED NOT NULL,
  
  INDEX (idPost),
  FOREIGN KEY (idPost) REFERENCES Post(id) ON DELETE CASCADE
);

CREATE TABLE Tag (
  id    BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT,
  name  VARCHAR(255) UNIQUE NOT NULL,
  color ENUM('red', 'orange', 'yellow', 'blue', 'purple', 'green') NOT NULL
);

CREATE TABLE Mark (
  idTag  BIGINT UNSIGNED,
  idPost BIGINT UNSIGNED,
  
  PRIMARY KEY (idTag, idPost),
  INDEX (idTag),
  INDEX (idPost),
  FOREIGN KEY (idTag) REFERENCES Tag(id) ON DELETE CASCADE,
  FOREIGN KEY (idPost) REFERENCES Post(id) ON DELETE CASCADE
);

COMMIT;
